---
import client from "../../tina/__generated__/client";

const resp = await client.queries.postConnection();
const posts = (resp.data.postConnection?.edges ?? [])
  .map((e) => e?.node ?? null)
  .filter((n): n is NonNullable<typeof n> => n !== null);

// kalau kamu pakai subfolder di content/blog, pakai breadcrumbs:
const toSlug = (n: (typeof posts)[number]) =>
  n._sys.breadcrumbs?.length ? n._sys.breadcrumbs.join("/") : n._sys.filename;

// Format date helper
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
};
---

{
  posts.map((p) => {
    const slug = toSlug(p);
    return (
      <a
        href={`/blog/${slug}`}
        class="tweet-card"
        style="text-decoration: none; color: inherit; display: block;"
      >
        <div class="tweet-card-header">
          <img src="/user-profile.jpg" alt="Avatar" class="tweet-avatar" />
          <div class="tweet-content">
            <div class="tweet-author-row">
              <span class="tweet-author-name">Nanda Kresnatara</span>
              <span class="tweet-author-handle">@taradevio</span>
              {p.date && <span class="tweet-date">{formatDate(p.date)}</span>}
            </div>

            <div class="tweet-text">{p.description}</div>

            <div class="tweet-link-preview">
              {p.image && (
                <img
                  src={p.image}
                  alt={p.alt ?? p.title}
                  class="tweet-link-preview-image"
                />
              )}
              <div class="tweet-link-preview-content">
                <div class="tweet-link-preview-title">{p.title}</div>
                <div class="tweet-link-preview-description">
                  Read full article â†’
                </div>
              </div>
            </div>
          </div>
        </div>
      </a>
    );
  })
}

{
  posts.length === 0 && (
    <div class="feed-empty">
      <p>No blog posts yet. Stay tuned!</p>
    </div>
  )
}
