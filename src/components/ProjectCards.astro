---
import client from "../../tina/__generated__/client";

const [resp, globalResp] = await Promise.all([
  client.queries.projectConnection(),
  client.queries.global({ relativePath: "index.md" }),
]);

const projectContent = (resp.data.projectConnection?.edges ?? [])
  .map((e) => {
    const node = e?.node;
    if (!node) return null;
    return {
      title: node.title,
      description: node.description,
      stack: node.stack ?? [],
      link: node.link,
      slug: `/projects/${node._sys.filename}`,
    };
  })
  .filter((n): n is NonNullable<typeof n> => n !== null);

const globalData = globalResp.data.global;

// Format date helper
const formatDate = () => {
  const now = new Date();
  return now.toLocaleDateString("en-US", { month: "short", day: "numeric" });
};
---

{
  projectContent.map(({ title, description, stack, slug }) => (
    <a
      href={slug}
      class="tweet-card"
      style="text-decoration: none; color: inherit; display: block;"
    >
      <div class="tweet-card-header">
        <img
          src={globalData.profilePicture}
          alt="Avatar"
          class="tweet-avatar"
        />
        <div class="tweet-content">
          <div class="tweet-author-row">
            <span class="tweet-author-name">{globalData.name}</span>
            <span class="tweet-author-handle">{globalData.handle}</span>
            <span class="tweet-date">{formatDate()}</span>
          </div>

          <div class="tweet-text">
            <div class="tweet-title">{title}</div>
            {description}
          </div>

          <div class="tweet-tags">
            {stack.map((item) => (
              <span class="tweet-tag">{item}</span>
            ))}
          </div>
        </div>
      </div>
    </a>
  ))
}

{
  projectContent.length === 0 && (
    <div class="tweet-card">
      <div class="feed-empty">
        <p>Under Development</p>
      </div>
    </div>
  )
}
