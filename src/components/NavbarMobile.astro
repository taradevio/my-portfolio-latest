---
import client from "../../tina/__generated__/client";
import { Guitar } from "@lucide/astro";
import ThemeSwitcher from "./ThemeSwitcher.astro";

const [projectResp, postResp, experienceResp] = await Promise.all([
  client.queries.projectConnection(),
  client.queries.postConnection(),
  (client.queries as any).experienceConnection(),
]);

const counts = {
  projects: projectResp.data.projectConnection?.totalCount ?? 0,
  blogs: postResp.data.postConnection?.totalCount ?? 0,
  experience: experienceResp.data.experienceConnection?.totalCount ?? 0,
};

const pluralize = (count: number, singular: string, plural: string) =>
  `${count} ${count === 1 ? singular : plural}`;
---

<!-- Mobile Header -->
<div class="mobile-header" id="mobile-header">
  <div class="mobile-persistent-identity">
    <Guitar size={22} class="mobile-guitar-icon" />
    <span class="mobile-nanda-text">ナンダ</span>
  </div>

  <div
    class="mobile-header-info"
    id="mobile-header-info"
    style="opacity: 0; transform: translateX(-10px); transition: all 0.3s ease;"
  >
    <div class="mobile-header-title">Nanda Kresnatara</div>
    <div
      class="mobile-header-subtitle"
      id="mobile-header-count"
      style="color: var(--kessoku-pink); font-weight: 500;"
    >
      {pluralize(counts.projects, "project", "projects")}
    </div>
  </div>

  <div class="mobile-theme-wrapper">
    <ThemeSwitcher />
  </div>
</div>

<script is:inline define:vars={{ counts }}>
  window.kessokuCounts = counts;
</script>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  (function () {
    const headerInfo = document.getElementById("mobile-header-info");
    const countDisplay = document.getElementById("mobile-header-count");
    // Removed legacy toggle reference

    // Tab based count display
    window.addEventListener("tab-change", (e: any) => {
      const tab = e.detail;
      const counts = (window as any).kessokuCounts || {
        projects: 0,
        experience: 0,
        blogs: 0,
      };
      let count = 0;
      let label = "";

      if (tab === "projects") {
        count = counts.projects;
        label = count === 1 ? "project" : "projects";
      } else if (tab === "experience") {
        count = counts.experience;
        label = count === 1 ? "experience" : "experiences";
      } else if (tab === "blogs") {
        count = counts.blogs;
        label = count === 1 ? "post" : "posts";
      }

      if (countDisplay) {
        countDisplay.textContent = `${count} ${label}`;
      }
    });

    // Scroll reveal with GSAP
    if (headerInfo) {
      const persistentIdentity = document.querySelector(
        ".mobile-persistent-identity",
      );

      gsap.to(headerInfo, {
        opacity: 1,
        x: 0,
        duration: 0.3,
        scrollTrigger: {
          trigger: "body",
          start: "150 top",
          toggleActions: "play none none reverse",
        },
      });
    }
  })();
</script>
